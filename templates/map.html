<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OMTW-Mapï½œå°ç£å®šå‘è¡Œå‹•å¸«è³‡åœ°åœ–</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Esri Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder/dist/esri-leaflet-geocoder.css" />
  <link rel="icon" href="{{ url_for('static', filename='img/omtw.ico') }}" type="image/x-icon">
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100vh;
      width: 100%;
      max-width: 100%;
    }
    .btn {
      padding: 0.5rem 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      margin: 0.3rem;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    .legend {
      max-width: 250px;
      max-height: 30vh;  /* åŠ é€™è¡Œé™åˆ¶æœ€å¤§é«˜åº¦ */
      overflow-y: auto;  /* å¯ä¸Šä¸‹æ»‘å‹• */
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      pointer-events: auto;
      overflow-wrap: break-word;
      z-index: 1000;
    }

    @media (max-width: 480px) {
      .legend {
        max-width: 90vw;
      }
    }

    .legend-title {
      font-weight: bold;
      margin-bottom: 6px;
    }

    /* ğŸ–¼ï¸ æ¯ä¸€è¡Œåœ–ä¾‹ */
    .legend-item {
      display: flex;
      align-items: center;
      white-space: nowrap;
      gap: 6px;
    }

    /* ğŸ¯ é™åˆ¶åœ–ç‰‡å¤§å°ï¼Œé¿å…åƒåŸåœ–å°ºå¯¸ */
    .legend-icon {
      width: 20px;
      height: 20px;
      object-fit: contain;
      margin-right: 6px;
      flex-shrink: 0;
    }
      .leaflet-control-search {
      max-width: 90%;
      box-sizing: border-box;
    }

    @media (max-width: 480px) {
      .leaflet-control-search {
        width: 90%;
        font-size: 14px;
        margin: 0 auto;
      }
    }

    .leaflet-popup-content {
      max-width: 250px;
      word-wrap: break-word;
      white-space: normal;
      font-size: 14px;
      line-height: 1.4;
    }

    @media (max-width: 480px) {
      .leaflet-popup-content {
        max-width: 80vw;  /* æ‰‹æ©Ÿä¸Šæœ€å¤šä½”å…«æˆå¯¬ */
        font-size: 13px;
      }
    }

    .mobile-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #ffffffee;
      display: flex;
      justify-content: space-around;
      padding: 6px 0;
      border-top: 1px solid #ccc;
      font-size: 16px;
      z-index: 1000;
    }

  </style>
</head>

<body>
  <!-- æŒ‰éˆ•åˆ— -->
  <div style="position: absolute; top: 10px; left: 10px; z-index: 9999; background: white; padding: 10px; border-radius: 8px;">
    {% if current_user.is_authenticated %}
      {% if user_profile %}
        <a href="{{ url_for('edit_profile', profile_id=user_profile.id) }}"><button>æ›´æ–°åœ–æ¨™</button></a>
        <a href="{{ url_for('delete_profile', profile_id=user_profile.id) }}"><button>åˆªé™¤åœ–æ¨™</button></a>
      {% else %}
        <a href="{{ url_for('profile') }}"><button>å»ºç«‹åœ–æ¨™</button></a>
      {% endif %}
      <a href="{{ url_for('logout') }}"><button>ç™»å‡º</button></a>
    {% else %}
      <a href="{{ url_for('login') }}"><button>ç™»å…¥</button></a>
    {% endif %}

    <!-- â• åŠ å…¥ç„¡éšœç¤™æŸ¥æ‰¾æŒ‰éˆ• -->
    <a href="{{ url_for('accessible_search') }}"><button>ğŸ¦¯ ç„¡éšœç¤™æŸ¥æ‰¾é é¢</button></a>

    <button onclick="showHelp()">ä½¿ç”¨èªªæ˜</button>

    {% if current_user.is_authenticated and current_user.is_admin %}
      <a href="{{ url_for('admin_panel') }}"><button>ğŸ› ï¸ ç®¡ç†å¾Œå°</button></a>
    {% endif %}
  </div>

  {% if current_user.is_authenticated and not user_profile %}
    <div style="position: absolute; bottom: 20px; left: 20px; z-index: 9999; background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
      ğŸ‘‹ æ­¡è¿åŠ å…¥ï¼ä½ å°šæœªå»ºç«‹åœ–æ¨™ï¼Œé»é¸ã€Œå»ºç«‹åœ–æ¨™ã€æŒ‰éˆ•å³å¯å®Œæˆã€‚
    </div>
  {% endif %}

  <!-- Flash è¨Šæ¯æç¤º -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div style="position: absolute; top: 10px; right: 10px; background: #dff0d8; color: #3c763d; padding: 10px; border: 1px solid #d6e9c6; border-radius: 5px; z-index: 9999;">
        {% for message in messages %}
          <div>{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet-geocoder/dist/esri-leaflet-geocoder.js"></script>

  <script>
    function showHelp() {
      alert("ğŸ§­ ä½¿ç”¨èªªæ˜ï¼š\n\nğŸ“ åœ°åœ–ä¸Šæ¯å€‹åœ–æ¨™ä»£è¡¨ä¸€ä½å®šå‘è¡Œå‹•è€å¸«ã€‚\nğŸ‘¤ ç™»å…¥å¾Œå¯æ–°å¢æˆ–æ›´æ–°è‡ªå·±çš„åœ–æ¨™è³‡è¨Šã€‚\nğŸ“ è‹¥ä¸æƒ³å…¬é–‹çœŸå¯¦å§“åï¼Œå¯é¸æ“‡ç”¨æš±ç¨±é¡¯ç¤ºã€‚\n\nâ¡ é»é¸åœ–æ¨™å¯æŸ¥çœ‹è€å¸«è³‡æ–™ã€‚ï¼ˆå…§å®¹ä¾è€å¸«æ–¹ä¾¿å…¬é–‹ç¨‹åº¦ï¼‰");
    }

    document.addEventListener("DOMContentLoaded", function () {
      const map = L.map('map').setView([23.6978, 120.9605], 7);

      L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', {
        attribution: '&copy; å…§æ”¿éƒ¨åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ',
        maxZoom: 19
      }).addTo(map);

      const searchControl = L.esri.Geocoding.geosearch().addTo(map);
      const results = L.layerGroup().addTo(map);

      searchControl.on('results', function (data) {
        results.clearLayers();
        for (let i = 0; i < data.results.length; i++) {
          results.addLayer(L.marker(data.results[i].latlng));
        }
      });

      const timeMap = {
        'weekday_day': 'å¹³æ—¥ç™½å¤©',
        'weekday_night': 'å¹³æ—¥æ™šä¸Š',
        'weekend_day': 'é€±æœ«ç™½å¤©',
        'weekend_night': 'é€±æœ«æ™šä¸Š'
      };
      const transportMap = {
        'public': 'å¤§çœ¾é‹è¼¸',
        'scooter': 'æ©Ÿè»Š',
        'car': 'é–‹è»Š',
      };
      const langMap = {
        'mandarin': 'è¯èª',
        'taiwanese': 'å°èª',
        'english': 'è‹±èª',
        'hakka': 'å®¢èª',
        'other': 'å…¶ä»–',
      };

      fetch('/api/teachers')
        .then(res => res.json())
        .then(data => {
          data.forEach(t => {
            const displayName = t.real_name_public ? `${t.real_name}ï¼ˆ${t.nickname}ï¼‰` : t.nickname;
            const timeText = t.available_times?.split(',').map(k => timeMap[k] || k).join('ã€') || 'ï¼ˆæœªæä¾›ï¼‰';
            const transportText = t.transport_modes?.split(',').map(k => transportMap[k] || k).join('ã€') || 'ï¼ˆæœªæä¾›ï¼‰';
            const langText = t.lang_skills?.split(',').map(k => langMap[k] || k).join('ã€') || 'ï¼ˆæœªæä¾›ï¼‰';

            const customIcon = L.icon({
              iconUrl: t.can_teach_online ? '/static/img/omtw2.png' : '/static/img/omtw3.png',
              iconSize: [34, 34],
              iconAnchor: [16, 32],
              popupAnchor: [0, -32]
            });

            const marker = L.marker([t.lat, t.lng], { icon: customIcon }).addTo(map);
            marker.bindPopup(`
            <div style="max-width:250px;word-break:break-word;">
              <b>${t.name}</b><br>
              æ•™å­¸åœ°å€ï¼š${t.service_area}<br>
              çµè¨“å¹´ä»½ï¼š${t.certification_year}<br>
              çµè¨“è­‰è™Ÿï¼š${t.certification_number}<br>
              åœ‹å®¶è­‰è™Ÿï¼š${t.license_number || 'ï¼ˆæœªæä¾›ï¼‰'}<br>
              <a href="/profile/view/${t.id}" target="_blank">ğŸ” è©³ç´°å…§å®¹</a>
            </div>
            `);
          });

          const legend = L.control({ position: 'bottomright' });

          legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            L.DomEvent.disableClickPropagation(div);  // âœ… ä¿®æ­£å¡ä½å•é¡Œ
            div.innerHTML = `
              <div class="legend-title">åœ–æ¨™èªªæ˜ï¼š</div>
              <div class="legend-item">
                <img src="/static/img/omtw2_legend.png" class="legend-icon"> å…¼å…·ç”Ÿæ´»æŠ€èƒ½æ•™å­¸è³‡æ ¼
              </div>
              <div class="legend-item">
                <img src="/static/img/omtw3_legend.png" class="legend-icon"> åƒ…æä¾›å®šå‘è¡Œå‹•æ•™å­¸
              </div>
            `;
            return div;
          };

          legend.addTo(map);

        })
        .then(() => {
          setTimeout(() => {
            map.invalidateSize();
          }, 300);
        });

      window.addEventListener('resize', () => {
        map.invalidateSize();
      });
    });
  </script>
</body>
</html>
